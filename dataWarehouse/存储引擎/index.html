
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="li-xiao的个人网站">
      
      
        <meta name="author" content="li-xiao">
      
      
        <link rel="canonical" href="https://melodylx666.github.io/lx-bigdata/dataWarehouse/%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/">
      
      
        <link rel="prev" href="../%E6%95%B0%E4%BB%93/">
      
      
        <link rel="next" href="../interview/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.16">
    
    
      
        <title>存储引擎 - lx-bigdata</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/katex.min.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="orange">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="lx-bigdata" class="md-header__button md-logo" aria-label="lx-bigdata" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            lx-bigdata
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              存储引擎
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="orange"  aria-label="切换至夜间模式"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="切换至夜间模式" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="orange"  aria-label="切换至日间模式"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="切换至日间模式" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/melodylx666/lx-bigdata" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    lx-bigdata
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../Project/" class="md-tabs__link">
          
  
  
    
  
  随手总结

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../frameworkAnalysis/" class="md-tabs__link">
          
  
  
    
  
  总结分析

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../" class="md-tabs__link">
          
  
  
    
  
  数据存储与计算

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../LANG/" class="md-tabs__link">
          
  
  
    
  
  计算机基础

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../backend/" class="md-tabs__link">
          
  
  
    
  
  软件开发

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../TEST/" class="md-tabs__link">
          
  
  
    
  
  考试复习

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="lx-bigdata" class="md-nav__button md-logo" aria-label="lx-bigdata" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    lx-bigdata
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/melodylx666/lx-bigdata" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    lx-bigdata
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../Project/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    随手总结
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2" id="__nav_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            随手总结
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Project/dynamic-Cep/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    动态CEP解析
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Project/econ-rule-engine/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    金融风控引擎
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Project/AbstractStreamOperatorDesign/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    自定义StreamOperator
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Project/ruleCoreSummary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    规则动态加载
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Project/first-intern-summary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    第一段实习总结
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../BaseSkill/scala-reflection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Scala Reflection
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../BaseSkill/scala-scopt/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Scopt库
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../BaseSkill/prepare/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    秋招复习
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../BaseSkill/mac_learn/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    自用Mac入手文章指南合集
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../frameworkAnalysis/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    总结分析
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            总结分析
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frameworkAnalysis/asyncToolLearn/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    asyncTool框架梳理
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../JVM/JVM%E5%B9%B6%E5%8F%91%E6%80%BB%E7%BB%93/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    JVM并发总结
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frameworkAnalysis/io/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Java/Scala I/O
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../BaseSkill/design-pattern/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    设计模式总结
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frameworkAnalysis/leveldb_learn/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    LevelDB源码学习
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    数据存储与计算
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4" id="__nav_4_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            数据存储与计算
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kafka/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Kafka总结
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hadoop/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    HDFS 与 YARN
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E5%A4%A7%E6%95%B0%E6%8D%AESQL/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    大数据SQL剖析
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../flink_learn/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Flink总结
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E6%95%B0%E4%BB%93/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    数仓理论总结
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    存储引擎
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    存储引擎
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      数据结构
    </span>
  </a>
  
    <nav class="md-nav" aria-label="数据结构">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      基础结构
    </span>
  </a>
  
    <nav class="md-nav" aria-label="基础结构">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      数组和链表
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      哈希结构
    </span>
  </a>
  
    <nav class="md-nav" aria-label="哈希结构">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      哈希表
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bitmap" class="md-nav__link">
    <span class="md-ellipsis">
      BitMap
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bloomfilter" class="md-nav__link">
    <span class="md-ellipsis">
      BloomFilter
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      树结构
    </span>
  </a>
  
    <nav class="md-nav" aria-label="树结构">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bst" class="md-nav__link">
    <span class="md-ellipsis">
      BST
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#skiplist" class="md-nav__link">
    <span class="md-ellipsis">
      SkipList实现
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#btree" class="md-nav__link">
    <span class="md-ellipsis">
      BTree实现
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      设计思路
    </span>
  </a>
  
    <nav class="md-nav" aria-label="设计思路">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      从开销看设计
    </span>
  </a>
  
    <nav class="md-nav" aria-label="从开销看设计">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bb-tree" class="md-nav__link">
    <span class="md-ellipsis">
      B&amp;B+ Tree
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      从请求处理看设计
    </span>
  </a>
  
    <nav class="md-nav" aria-label="从请求处理看设计">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lsm" class="md-nav__link">
    <span class="md-ellipsis">
      LSM
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      具体实现
    </span>
  </a>
  
    <nav class="md-nav" aria-label="具体实现">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#innodb" class="md-nav__link">
    <span class="md-ellipsis">
      InnoDB
    </span>
  </a>
  
    <nav class="md-nav" aria-label="InnoDB">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      行格式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      数据页
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    <span class="md-ellipsis">
      索引
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    <span class="md-ellipsis">
      表空间
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lsm_1" class="md-nav__link">
    <span class="md-ellipsis">
      LSM
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LSM">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    <span class="md-ellipsis">
      双组件结构
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    <span class="md-ellipsis">
      多组件结构
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    <span class="md-ellipsis">
      实际结构
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    <span class="md-ellipsis">
      事务专项
    </span>
  </a>
  
    <nav class="md-nav" aria-label="事务专项">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    <span class="md-ellipsis">
      核心概念
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_21" class="md-nav__link">
    <span class="md-ellipsis">
      页缓存
    </span>
  </a>
  
    <nav class="md-nav" aria-label="页缓存">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_22" class="md-nav__link">
    <span class="md-ellipsis">
      页缓存的语义
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_23" class="md-nav__link">
    <span class="md-ellipsis">
      缓存回收
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_24" class="md-nav__link">
    <span class="md-ellipsis">
      锁定页
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_25" class="md-nav__link">
    <span class="md-ellipsis">
      页置换
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_26" class="md-nav__link">
    <span class="md-ellipsis">
      恢复
    </span>
  </a>
  
    <nav class="md-nav" aria-label="恢复">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#wal" class="md-nav__link">
    <span class="md-ellipsis">
      WAL
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_27" class="md-nav__link">
    <span class="md-ellipsis">
      操作日志和数据日志
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#steal-or-force" class="md-nav__link">
    <span class="md-ellipsis">
      steal or force
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aries" class="md-nav__link">
    <span class="md-ellipsis">
      ARIES
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_28" class="md-nav__link">
    <span class="md-ellipsis">
      并发控制
    </span>
  </a>
  
    <nav class="md-nav" aria-label="并发控制">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_29" class="md-nav__link">
    <span class="md-ellipsis">
      可串行化
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_30" class="md-nav__link">
    <span class="md-ellipsis">
      事务隔离
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_31" class="md-nav__link">
    <span class="md-ellipsis">
      隔离级别
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_32" class="md-nav__link">
    <span class="md-ellipsis">
      乐观并发控制
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_33" class="md-nav__link">
    <span class="md-ellipsis">
      多版本并发控制
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_34" class="md-nav__link">
    <span class="md-ellipsis">
      悲观并发控制
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../interview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    查缺补漏
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../graphDB/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    图数据库总结
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../learn_db_from_paper/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    从论文学隔离级别
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../LANG/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    计算机基础
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5" id="__nav_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            计算机基础
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../BaseSkill/store/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    操作系统
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../LANG/DS-leetcode/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    数据结构与算法
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../BaseSkill/gitSummary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Git 规范总结
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../BaseSkill/devops/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ci/cd流程
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../backend/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    软件开发
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6" id="__nav_6_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            软件开发
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../backend/springboot-doc/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    springboot
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    前端开发
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/Vue3%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Vue
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/typescript/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    TS学习
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../TEST/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    考试复习
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7" id="__nav_7_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            考试复习
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../TEST/javaweb/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    javaweb
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../TEST/%E6%95%B0%E5%AD%97%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    数字图像处理
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../TEST/blockchain/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    blockchain
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../TEST/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    软件工程
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      数据结构
    </span>
  </a>
  
    <nav class="md-nav" aria-label="数据结构">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      基础结构
    </span>
  </a>
  
    <nav class="md-nav" aria-label="基础结构">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      数组和链表
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      哈希结构
    </span>
  </a>
  
    <nav class="md-nav" aria-label="哈希结构">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      哈希表
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bitmap" class="md-nav__link">
    <span class="md-ellipsis">
      BitMap
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bloomfilter" class="md-nav__link">
    <span class="md-ellipsis">
      BloomFilter
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      树结构
    </span>
  </a>
  
    <nav class="md-nav" aria-label="树结构">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bst" class="md-nav__link">
    <span class="md-ellipsis">
      BST
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#skiplist" class="md-nav__link">
    <span class="md-ellipsis">
      SkipList实现
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#btree" class="md-nav__link">
    <span class="md-ellipsis">
      BTree实现
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      设计思路
    </span>
  </a>
  
    <nav class="md-nav" aria-label="设计思路">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      从开销看设计
    </span>
  </a>
  
    <nav class="md-nav" aria-label="从开销看设计">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bb-tree" class="md-nav__link">
    <span class="md-ellipsis">
      B&amp;B+ Tree
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      从请求处理看设计
    </span>
  </a>
  
    <nav class="md-nav" aria-label="从请求处理看设计">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lsm" class="md-nav__link">
    <span class="md-ellipsis">
      LSM
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      具体实现
    </span>
  </a>
  
    <nav class="md-nav" aria-label="具体实现">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#innodb" class="md-nav__link">
    <span class="md-ellipsis">
      InnoDB
    </span>
  </a>
  
    <nav class="md-nav" aria-label="InnoDB">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      行格式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      数据页
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    <span class="md-ellipsis">
      索引
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    <span class="md-ellipsis">
      表空间
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lsm_1" class="md-nav__link">
    <span class="md-ellipsis">
      LSM
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LSM">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    <span class="md-ellipsis">
      双组件结构
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    <span class="md-ellipsis">
      多组件结构
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    <span class="md-ellipsis">
      实际结构
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    <span class="md-ellipsis">
      事务专项
    </span>
  </a>
  
    <nav class="md-nav" aria-label="事务专项">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    <span class="md-ellipsis">
      核心概念
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_21" class="md-nav__link">
    <span class="md-ellipsis">
      页缓存
    </span>
  </a>
  
    <nav class="md-nav" aria-label="页缓存">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_22" class="md-nav__link">
    <span class="md-ellipsis">
      页缓存的语义
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_23" class="md-nav__link">
    <span class="md-ellipsis">
      缓存回收
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_24" class="md-nav__link">
    <span class="md-ellipsis">
      锁定页
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_25" class="md-nav__link">
    <span class="md-ellipsis">
      页置换
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_26" class="md-nav__link">
    <span class="md-ellipsis">
      恢复
    </span>
  </a>
  
    <nav class="md-nav" aria-label="恢复">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#wal" class="md-nav__link">
    <span class="md-ellipsis">
      WAL
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_27" class="md-nav__link">
    <span class="md-ellipsis">
      操作日志和数据日志
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#steal-or-force" class="md-nav__link">
    <span class="md-ellipsis">
      steal or force
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aries" class="md-nav__link">
    <span class="md-ellipsis">
      ARIES
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_28" class="md-nav__link">
    <span class="md-ellipsis">
      并发控制
    </span>
  </a>
  
    <nav class="md-nav" aria-label="并发控制">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_29" class="md-nav__link">
    <span class="md-ellipsis">
      可串行化
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_30" class="md-nav__link">
    <span class="md-ellipsis">
      事务隔离
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_31" class="md-nav__link">
    <span class="md-ellipsis">
      隔离级别
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_32" class="md-nav__link">
    <span class="md-ellipsis">
      乐观并发控制
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_33" class="md-nav__link">
    <span class="md-ellipsis">
      多版本并发控制
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_34" class="md-nav__link">
    <span class="md-ellipsis">
      悲观并发控制
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
    <a href="https://github.com/melodylx666/lx-bigdata/edit/main/docs/dataWarehouse/存储引擎.md" title="编辑此页" class="md-content__button md-icon" rel="edit">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  


<h1 id="_1">存储引擎<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h1>
<p>单机存储引擎从<code>读</code>和<code>写</code>两个方面看，可以分为<code>读多写少</code>和<code>写多读少</code>。比如之前分析的日志结构文件系统，就是针对<code>写多读少</code>场景的专门优化的文件系统，其通过加中间层以及<code>copy on write</code>的方式，将所有的写统一为按段的顺序写，从而加速写入效率。</p>
<p>具体的存储引擎分下述两类：</p>
<ul>
<li><code>读多写少</code> B &amp; B+树</li>
<li><code>写多读少</code> LSM-Tree，LSM-Array等</li>
</ul>
<p>每种引擎又在数据落盘时机上分为<code>同步落盘</code>和<code>异步落盘</code>，后者通常通过<code>预写WAL</code>实现。</p>
<h2 id="_2">数据结构<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<h3 id="_3">基础结构<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<h4 id="_4">数组和链表<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h4>
<p>从内存管理的角度来看，数组和链表就是分别代表了数据组织两个特性，也就是顺序组织和离散组织。</p>
<p>最终的所有高级结构都会归结为这两个基本结构来实现。</p>
<p>这两者的侧重点有所不同，</p>
<ul>
<li>数组的<code>按下标访问和尾部追加</code>都是<code>O(1)</code>的</li>
<li>链表的<code>插入，删除的执行</code>是<code>O(1)</code>，但是访问过程是<code>O(n)</code>的。</li>
</ul>
<h3 id="_5">哈希结构<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<h4 id="_6">哈希表<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h4>
<blockquote>
<p><a href="https://zh.wikipedia.org/wiki/%E5%93%88%E5%B8%8C%E8%A1%A8">散列表 - 维基百科，自由的百科全书 (wikipedia.org)</a></p>
</blockquote>
<h4 id="bitmap">BitMap<a class="headerlink" href="#bitmap" title="Permanent link">&para;</a></h4>
<p><strong>本质</strong></p>
<p>按照<code>bit</code>来存储海量无重复数据(<code>比如ID</code>)的小状态(通常是<code>二值状态(true/false)</code>)。</p>
<p>比如<code>10亿</code>个<code>int</code>判断某个数是否存在。则存储开销可以减小为<code>1/32</code>，使用<code>bit</code>位置下标代表具体数字，该位的值代表是否存在。</p>
<p><strong>实现</strong></p>
<p>通常的实现是通过<code>Array[Int]</code>来实现的。若现在要寻找某个数的状态，其实也就是寻找对应<code>Int的某个位是否为1</code>。</p>
<p>可以将其看做二维bit矩阵，则对应位置为<code>arr(x/32)(x % 32)</code>。</p>
<p>但是实际上对于第二维度的<code>Int</code>来说不能再直接索引了，只能通过<code>arr(x/32) &amp; (1&lt;&lt;(x%32)))</code>来实现。</p>
<p><strong>API</strong></p>
<p>在Java/Scala中，都提供了<code>BitSet</code>类，其就是一个专用的针对<code>Int</code>类型的<code>BitMap</code>。可以看到其构造方法甚至都不是泛型方法，因为内部已经规定是<code>Int</code>。</p>
<p>它同时是一个<code>SortedSet</code>。</p>
<div class="language-java highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><span class="n">object</span><span class="w"> </span><span class="n">BitSetDemo</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-2"><span class="w">  </span><span class="n">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">:</span><span class="w"> </span><span class="n">Array</span><span class="o">[</span><span class="n">String</span><span class="o">]</span><span class="p">):</span><span class="w"> </span><span class="n">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-3"><span class="w">    </span><span class="kn">import</span><span class="w"> </span><span class="nn">scala.collection.BitSet</span>
</span><span id="__span-0-4"><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BitSet</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
</span><span id="__span-0-5"><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="n">set2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BitSet</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">9</span><span class="p">)</span>
</span><span id="__span-0-6"><span class="w">    </span><span class="n">println</span><span class="p">(</span><span class="n">set</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">set2</span><span class="p">)</span>
</span><span id="__span-0-7"><span class="w">    </span><span class="n">println</span><span class="p">(</span><span class="n">set</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">set2</span><span class="p">)</span>
</span><span id="__span-0-8"><span class="w">    </span><span class="n">println</span><span class="p">(</span><span class="n">set</span><span class="w"> </span><span class="o">&amp;~</span><span class="w"> </span><span class="n">set2</span><span class="p">)</span>
</span><span id="__span-0-9"><span class="w">    </span><span class="n">println</span><span class="p">(</span><span class="n">set</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">set2</span><span class="p">)</span>
</span><span id="__span-0-10"><span class="w">  </span><span class="p">}</span>
</span><span id="__span-0-11"><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>结果如下:</p>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1">BitSet(1, 4, 5)
</span><span id="__span-1-2">BitSet(1, 2, 3, 4, 5, 7, 9)
</span><span id="__span-1-3">BitSet(2, 3)
</span><span id="__span-1-4">BitSet(2, 3, 7, 9)
</span></code></pre></div></td></tr></table></div>
<h4 id="bloomfilter">BloomFilter<a class="headerlink" href="#bloomfilter" title="Permanent link">&para;</a></h4>
<p><strong>本质</strong></p>
<p>长度为<code>n</code>的bit数组 + <code>k</code>个<code>Hash函数</code></p>
<p><strong>使用</strong></p>
<blockquote>
<p><a href="https://gallery.selfboot.cn/zh/algorithms/bloomfilter">布隆过滤器可视化 (selfboot.cn)</a></p>
</blockquote>
<p>可以看到，初始的时候设置<span class="arithmatex">\(n = 200,k = 6\)</span>.</p>
<p>然后每次添加一个字符串类型的<code>key</code>，都可以通过6个哈希函数计算出来的值，填充到6个位中。然后查找的时候只需要查看这些位是否为1即可大概率判断是否有该key。</p>
<p>其查询性能是<code>O(k)</code>的，与数据量无关，并且空间复杂度很低。</p>
<p><strong>假阳性</strong></p>
<p>很显然，bit数组不可能无限长。而总有可能不同<code>key</code>将同一个格子填满。那么在检验的时候本应该该位置为空的不为空了，则最终可能恰好认为该<code>key</code>在其中。</p>
<p>当然，如果一个数在有假阳性的条件下都被判断为不存在，则必然不存在，这也是数据库等应用使用它的根本原因，就是它可以提供这种<code>assert</code>。</p>
<h3 id="_7">树结构<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<h4 id="bst">BST<a class="headerlink" href="#bst" title="Permanent link">&para;</a></h4>
<p><strong>性质</strong></p>
<ol>
<li>若任意节点的左子树不空，则左子树上所有节点的值均小于它的根节点的值；</li>
<li>若任意节点的右子树不空，则右子树上所有节点的值均大于它的根节点的值；</li>
<li>任意节点的左、右子树也分别为二叉查找树；</li>
</ol>
<p><strong>性能</strong></p>
<p>搜索，插入，删除操作平均都为<code>O(log n)</code>。因为本质就是在<code>二分</code>。</p>
<p>最坏情况就是退化为一条边的斜二叉树(有序链表)，各种操作都劣化为<code>O(n)</code>。</p>
<p>如果要解决深度增加而引起的平均时间复杂度增加，则可以考虑使用<code>平衡树</code>进行深度限制，比如<code>AVL</code>树，就是带平衡限制的<code>BST</code>。但是还要权衡维护平衡所带来的额外开销。</p>
<h4 id="skiplist">SkipList实现<a class="headerlink" href="#skiplist" title="Permanent link">&para;</a></h4>
<blockquote>
<p><a href="https://zh.wikipedia.org/wiki/%E8%B7%B3%E8%B7%83%E5%88%97%E8%A1%A8">跳跃列表 - 维基百科，自由的百科全书 (wikipedia.org)</a></p>
</blockquote>
<p><strong>背景</strong></p>
<blockquote>
<p>跳跃列表是在很多应用中有可能替代平衡树而作为实现方法的一种数据结构。跳跃列表的算法有同平衡树一样的渐进的预期时间边界，并且更简单、更快速和使用更少的空间</p>
</blockquote>
<p>跳表在很多场景下可以取代平衡树以及弱平衡树(红黑树)。</p>
<p>它是针对有序集合所做出的优化，比如需要对有序集合做大量的范围(投影)查找。和哈希表使用场景完全不同，后者往往是无序的并且注重<code>k-v</code>存储。</p>
<p><strong>性能</strong></p>
<p>搜索，插入，删除操作平均都是<code>O(logn)</code>，同样是在二分。</p>
<p>最差情况均是劣化到<code>O(n)</code>，这是它的缺点之一。</p>
<p><strong>原理</strong></p>
<p>它是一种概率性数据结构，是有普通的有序链表向上按层构建而成的，也就是不断向上添加索引通道，达到二分的目的。由于是二分，所以它的层也不会很高，也就是个位数的层高。</p>
<p>第<code>i</code>层的元素在<code>i+1层</code>的的出现概率为<span class="arithmatex">\(p\)</span>，每个元素的出现层数平均为<span class="arithmatex">\(1 / (1 - p)\)</span>。而每个元素可以处于多层，就说明其可以有多个指针。</p>
<p><strong>API</strong></p>
<p>Scala只能使用<code>java.util.concurrent.ConcurrentSkipListMap/Set</code>，它们都实现了<code>NavigableMap/Set</code>接口。也就是说，支持返回某个值区间的投影。</p>
<p><strong>手搓跳表</strong></p>
<p><a href="https://leetcode.cn/problems/design-skiplist/description/">1206. 设计跳表 - 力扣（LeetCode）</a></p>
<p>用<code>Scala</code>的实现如下</p>
<div class="language-java highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><span class="kd">class</span> <span class="nf">Skiplist</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-2"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">maxLevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span>
</span><span id="__span-2-3"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">factor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.25</span>
</span><span id="__span-2-4"><span class="w">  </span><span class="c1">//dummy头结点</span>
</span><span id="__span-2-5"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="n">head</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SkiplistNode</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">maxLevel</span><span class="p">)</span>
</span><span id="__span-2-6"><span class="w">  </span><span class="c1">//当前的最大层高</span>
</span><span id="__span-2-7"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-2-8"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">util</span><span class="p">.</span><span class="na">Random</span><span class="p">()</span>
</span><span id="__span-2-9"><span class="w">  </span><span class="c1">//无论是查找，插入，删除，都是从head的最高层开始</span>
</span><span id="__span-2-10"><span class="w">  </span><span class="n">def</span><span class="w"> </span><span class="nf">search</span><span class="p">(</span><span class="n">target</span><span class="p">:</span><span class="w"> </span><span class="n">Int</span><span class="p">):</span><span class="w"> </span><span class="n">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-11"><span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">cur</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">head</span>
</span><span id="__span-2-12"><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">level</span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">){</span>
</span><span id="__span-2-13"><span class="w">      </span><span class="k">while</span><span class="p">(</span><span class="n">cur</span><span class="p">.</span><span class="na">forward</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">cur</span><span class="p">.</span><span class="na">forward</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="na">value</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">target</span><span class="p">){</span>
</span><span id="__span-2-14"><span class="w">        </span><span class="n">cur</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur</span><span class="p">.</span><span class="na">forward</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="__span-2-15"><span class="w">      </span><span class="p">}</span>
</span><span id="__span-2-16"><span class="w">    </span><span class="p">}</span>
</span><span id="__span-2-17"><span class="w">    </span><span class="c1">//最终会停在目标node的前一个node的level 0</span>
</span><span id="__span-2-18"><span class="w">    </span><span class="n">cur</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur</span><span class="p">.</span><span class="na">forward</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-2-19"><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">cur</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">cur</span><span class="p">.</span><span class="na">value</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">target</span><span class="p">){</span>
</span><span id="__span-2-20"><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-2-21"><span class="w">    </span><span class="p">}</span>
</span><span id="__span-2-22"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span>
</span><span id="__span-2-23"><span class="w">  </span><span class="p">}</span>
</span><span id="__span-2-24">
</span><span id="__span-2-25"><span class="w">  </span><span class="n">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">num</span><span class="p">:</span><span class="w"> </span><span class="n">Int</span><span class="p">):</span><span class="w"> </span><span class="n">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-26"><span class="w">    </span><span class="c1">//每层中比当前值小的最后一个node的引用集合</span>
</span><span id="__span-2-27"><span class="w">    </span><span class="c1">//</span>
</span><span id="__span-2-28"><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="n">update</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Array</span><span class="p">.</span><span class="na">fill</span><span class="o">[</span><span class="n">SkiplistNode</span><span class="o">]</span><span class="p">(</span><span class="n">maxLevel</span><span class="p">)(</span><span class="k">this</span><span class="p">.</span><span class="na">head</span><span class="p">)</span>
</span><span id="__span-2-29"><span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">cur</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">head</span>
</span><span id="__span-2-30"><span class="w">    </span><span class="c1">//从当前最高层开始向下每层找</span>
</span><span id="__span-2-31"><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">){</span>
</span><span id="__span-2-32"><span class="w">      </span><span class="k">while</span><span class="p">(</span><span class="n">cur</span><span class="p">.</span><span class="na">forward</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">cur</span><span class="p">.</span><span class="na">forward</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="na">value</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">num</span><span class="p">){</span>
</span><span id="__span-2-33"><span class="w">        </span><span class="n">cur</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur</span><span class="p">.</span><span class="na">forward</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="__span-2-34"><span class="w">      </span><span class="p">}</span>
</span><span id="__span-2-35"><span class="w">      </span><span class="n">update</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur</span>
</span><span id="__span-2-36"><span class="w">    </span><span class="p">}</span>
</span><span id="__span-2-37"><span class="w">    </span><span class="c1">//新插入的值的node的层数</span>
</span><span id="__span-2-38"><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="n">lv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">randomLevel</span><span class="p">()</span>
</span><span id="__span-2-39"><span class="w">    </span><span class="c1">//如果随机出来的层数比之前的都高，则更新level</span>
</span><span id="__span-2-40"><span class="w">    </span><span class="n">level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="n">max</span><span class="w"> </span><span class="n">lv</span>
</span><span id="__span-2-41"><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="n">newNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SkiplistNode</span><span class="p">(</span><span class="n">num</span><span class="p">,</span><span class="n">lv</span><span class="p">)</span>
</span><span id="__span-2-42"><span class="w">    </span><span class="c1">//从底向上更新</span>
</span><span id="__span-2-43"><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">lv</span><span class="p">){</span>
</span><span id="__span-2-44"><span class="w">      </span><span class="c1">//插入到本层cur的下一个节点</span>
</span><span id="__span-2-45"><span class="w">      </span><span class="n">newNode</span><span class="p">.</span><span class="na">forward</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">update</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="na">forward</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="__span-2-46"><span class="w">      </span><span class="n">update</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="na">forward</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newNode</span>
</span><span id="__span-2-47"><span class="w">    </span><span class="p">}</span>
</span><span id="__span-2-48"><span class="w">  </span><span class="p">}</span>
</span><span id="__span-2-49">
</span><span id="__span-2-50"><span class="w">  </span><span class="n">def</span><span class="w"> </span><span class="nf">erase</span><span class="p">(</span><span class="n">num</span><span class="p">:</span><span class="w"> </span><span class="n">Int</span><span class="p">):</span><span class="w"> </span><span class="n">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-51"><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="n">update</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Array</span><span class="p">.</span><span class="na">fill</span><span class="o">[</span><span class="n">SkiplistNode</span><span class="o">]</span><span class="p">(</span><span class="n">maxLevel</span><span class="p">)(</span><span class="kc">null</span><span class="p">)</span>
</span><span id="__span-2-52"><span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">cur</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">head</span>
</span><span id="__span-2-53"><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">level</span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">){</span>
</span><span id="__span-2-54"><span class="w">      </span><span class="k">while</span><span class="p">(</span><span class="n">cur</span><span class="p">.</span><span class="na">forward</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">cur</span><span class="p">.</span><span class="na">forward</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="na">value</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">num</span><span class="p">){</span>
</span><span id="__span-2-55"><span class="w">        </span><span class="n">cur</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur</span><span class="p">.</span><span class="na">forward</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="__span-2-56"><span class="w">      </span><span class="p">}</span>
</span><span id="__span-2-57"><span class="w">      </span><span class="n">update</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur</span>
</span><span id="__span-2-58"><span class="w">    </span><span class="p">}</span>
</span><span id="__span-2-59"><span class="w">    </span><span class="n">cur</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur</span><span class="p">.</span><span class="na">forward</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="c1">//当前要删除的块的最底层</span>
</span><span id="__span-2-60"><span class="w">    </span><span class="c1">//如果没有要删除的块</span>
</span><span id="__span-2-61"><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">cur</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">cur</span><span class="p">.</span><span class="na">value</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">num</span><span class="p">){</span>
</span><span id="__span-2-62"><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span>
</span><span id="__span-2-63"><span class="w">    </span><span class="p">}</span>
</span><span id="__span-2-64"><span class="w">    </span><span class="c1">//从底向上删除</span>
</span><span id="__span-2-65"><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">level</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="n">update</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="na">forward</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">cur</span><span class="p">)){</span>
</span><span id="__span-2-66"><span class="w">      </span><span class="n">update</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="na">forward</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur</span><span class="p">.</span><span class="na">forward</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="__span-2-67"><span class="w">    </span><span class="p">}</span>
</span><span id="__span-2-68"><span class="w">    </span><span class="c1">////最高层为空则删除</span>
</span><span id="__span-2-69"><span class="w">    </span><span class="k">while</span><span class="p">(</span><span class="n">level</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">head</span><span class="p">.</span><span class="na">forward</span><span class="p">(</span><span class="n">level</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">){</span>
</span><span id="__span-2-70"><span class="w">      </span><span class="n">level</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-2-71"><span class="w">    </span><span class="p">}</span>
</span><span id="__span-2-72"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-2-73">
</span><span id="__span-2-74"><span class="w">  </span><span class="p">}</span>
</span><span id="__span-2-75"><span class="w">  </span><span class="c1">//最底层每个节点出现在上层的最大层数</span>
</span><span id="__span-2-76"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">def</span><span class="w"> </span><span class="nf">randomLevel</span><span class="p">():</span><span class="n">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-77"><span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">lv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-2-78"><span class="w">    </span><span class="k">while</span><span class="p">(</span><span class="n">random</span><span class="p">.</span><span class="na">nextDouble</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">factor</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">lv</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">maxLevel</span><span class="p">){</span>
</span><span id="__span-2-79"><span class="w">      </span><span class="n">lv</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-2-80"><span class="w">    </span><span class="p">}</span>
</span><span id="__span-2-81"><span class="w">    </span><span class="n">lv</span>
</span><span id="__span-2-82"><span class="w">  </span><span class="p">}</span>
</span><span id="__span-2-83">
</span><span id="__span-2-84"><span class="p">}</span>
</span><span id="__span-2-85"><span class="kd">class</span> <span class="nf">SkiplistNode</span><span class="p">(</span><span class="n">_value</span><span class="p">:</span><span class="n">Int</span><span class="p">,</span><span class="n">_maxLevel</span><span class="p">:</span><span class="n">Int</span><span class="p">){</span>
</span><span id="__span-2-86"><span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_value</span>
</span><span id="__span-2-87"><span class="w">  </span><span class="c1">//这是跨层的多个引用，代表可能存在的每个层的下一个指向</span>
</span><span id="__span-2-88"><span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">forward</span><span class="p">:</span><span class="n">Array</span><span class="o">[</span><span class="n">SkiplistNode</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Array</span><span class="p">.</span><span class="na">fill</span><span class="o">[</span><span class="n">SkiplistNode</span><span class="o">]</span><span class="p">(</span><span class="n">_maxLevel</span><span class="p">)(</span><span class="kc">null</span><span class="p">)</span>
</span><span id="__span-2-89"><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="btree">BTree实现<a class="headerlink" href="#btree" title="Permanent link">&para;</a></h4>
<blockquote>
<p><a href="https://zh.wikipedia.org/wiki/B%E6%A0%91">B树 - 维基百科，自由的百科全书 (wikipedia.org)</a></p>
</blockquote>
<p><strong>定义</strong></p>
<p>一种自平衡的树，能够保证数据有序，并在对数时间内进行操作，可以视作一个一般化的BST，所以它一般也称为<code>多路搜索树</code>。</p>
<p>通常使用在需要大数据块组织的场景，比如数据库，文件系统。</p>
<blockquote>
<p>需要注意，它的内部节点是和叶子节点一样存储数据(键值对)的。</p>
</blockquote>
<p><strong>性能</strong></p>
<p>搜索，插入，删除平均都是<code>O(logn)</code>，并且最差情况同样是<code>O(logn)</code></p>
<p><strong>原理</strong></p>
<blockquote>
<p><a href="https://www.cnblogs.com/jing99/p/11736003.html">B树Java代码实现以及测试 - kosamino - 博客园 (cnblogs.com)</a></p>
<p>这里进行该代码的解析</p>
</blockquote>
<p>整体概览，一个<code>BTree</code>类有3个静态内部类：</p>
<ul>
<li><code>Entry</code>：键值对kV在BTree中的基本抽象，代表着一条数据，当然Scala可以直接用Tuple。在BTreeNode中通过数组存储。</li>
<li><code>BTreeNode</code>：一个BTree的节点，可能是内部节点，或者叶子节点。</li>
<li><code>SearchResult</code>：在一个BTree节点中搜索数据的返回结果，是一个<code>V</code>的包装。</li>
</ul>
<p>除此之外，还有其他的6个成员变量:</p>
<ul>
<li><code>DEFAULT_T</code>: 树默认的分支因子，也就是最大出度</li>
<li><code>t</code> 树的分支因子，可由用户定义，默认是<code>DEFAULT_T</code></li>
<li><code>minKeySize</code>：树的节点的最小的数据对(entry)数量，值为<code>t-1</code></li>
<li><code>maxKeySize</code>：树的节点的最大的数据对(entry)数量，值为<code>2t-1</code></li>
<li><code>root</code>：根节点</li>
<li><code>kComparetor</code>：键的比较逻辑，如果没有定义则会强转然后比较。</li>
</ul>
<p>数据和节点的组织逻辑如下：</p>
<ul>
<li>数据(一个个的KV)有序存储在每个节点上。</li>
<li>如果当前节点的有序数据为<code>x</code>个，则该节点可以间插<code>x+1</code>个子节点，从而定位到该节点的时候可以进行<code>BST</code>的搜索逻辑。</li>
</ul>
<p>看完了成员变量，则接下来跟着单测看核心方法.所有核心方法都从<code>root</code>开始进入。</p>
<p>首先是<code>insert</code>方法</p>
<p><img alt="image.png" src="../assets/insertStack.png?t=1738722781121" /></p>
<p>可以看到常规的调用栈如上图所示。</p>
<p>从<code>insert(k,v)</code>方法进入，如果root满了，则进行分裂变为非空。然后统一进行<code>insertNotFull</code>对节点进行插入。</p>
<p>后者是一个核心逻辑，所以我将代码贴出:</p>
<div class="language-java highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">insertNotFull</span><span class="p">(</span><span class="n">BTreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">V</span><span class="o">&gt;</span><span class="w"> </span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">Entry</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">V</span><span class="o">&gt;</span><span class="w"> </span><span class="n">entry</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-2"><span class="w">        </span><span class="k">assert</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">maxKeySize</span><span class="p">;</span>
</span><span id="__span-3-3">
</span><span id="__span-3-4"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="na">isLeaf</span><span class="p">())</span><span class="w"> </span><span class="c1">// 如果是叶子节点，直接插入</span>
</span><span id="__span-3-5"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="na">insertEntry</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
</span><span id="__span-3-6"><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-7"><span class="w">            </span><span class="cm">/* 找到entry在给定节点应该插入的位置，那么entry应该插入</span>
</span><span id="__span-3-8"><span class="cm">             * 该位置对应的子树中</span>
</span><span id="__span-3-9"><span class="cm">             */</span>
</span><span id="__span-3-10"><span class="w">            </span><span class="n">SearchResult</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="na">searchKey</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="na">getKey</span><span class="p">());</span>
</span><span id="__span-3-11"><span class="w">            </span><span class="c1">// 如果存在，则直接返回失败</span>
</span><span id="__span-3-12"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">isExist</span><span class="p">())</span>
</span><span id="__span-3-13"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
</span><span id="__span-3-14"><span class="w">            </span><span class="n">BTreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">V</span><span class="o">&gt;</span><span class="w"> </span><span class="n">childNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="na">childAt</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">getIndex</span><span class="p">());</span>
</span><span id="__span-3-15"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">childNode</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="c1">// 如果子节点是满节点</span>
</span><span id="__span-3-16"><span class="w">            </span><span class="p">{</span>
</span><span id="__span-3-17"><span class="w">                </span><span class="c1">// 则先分裂</span>
</span><span id="__span-3-18"><span class="w">                </span><span class="n">splitNode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">childNode</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="na">getIndex</span><span class="p">());</span>
</span><span id="__span-3-19"><span class="w">                </span><span class="cm">/* 如果给定entry的键大于分裂之后新生成项的键，则需要插入该新项的右边，</span>
</span><span id="__span-3-20"><span class="cm">                 * 否则左边。</span>
</span><span id="__span-3-21"><span class="cm">                 */</span>
</span><span id="__span-3-22"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">compare</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="na">getKey</span><span class="p">(),</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="na">entryAt</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">getIndex</span><span class="p">()).</span><span class="na">getKey</span><span class="p">())</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-3-23"><span class="w">                    </span><span class="n">childNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="na">childAt</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">getIndex</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-3-24"><span class="w">            </span><span class="p">}</span>
</span><span id="__span-3-25"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">insertNotFull</span><span class="p">(</span><span class="n">childNode</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">);</span>
</span><span id="__span-3-26"><span class="w">        </span><span class="p">}</span>
</span><span id="__span-3-27"><span class="w">    </span><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>可以看到，这是一个递归调用的逻辑。<code>base case</code>就是当前节点为叶子节点，则直接<code>insertEntry</code>。具体逻辑原作者在这里的比较复杂，如果是<code>Scala</code>则可以直接进行<code>ListBuffer.insert</code>，但是这里的随机插入是<code>O(n)</code>的，应该可以有更佳的实现。</p>
<p>常规逻辑就是根据<code>key</code>，找到当前键值对应该插入的子树。具体来说，是对当前节点存储的有序<code>List&lt;Entry&gt;</code>进行二分逻辑，则可以找到应该递归进入的子节点位置。</p>
<p>如果子节点满了，先分裂变为不满的，然后将其传入子树进行插入的递归逻辑直到<code>base case</code>。</p>
<p>走到这里，我们可以发现就算父节点的数据没满，数据也全部是插入到叶子节点才结束的。可能会有这样的疑问：不是所有节点都存数据吗，那上面的节点的数据是怎么来的？</p>
<p>答案就在被多次调用的节点分裂<code>splitNode</code>的逻辑上。</p>
<p>我们首先来看这个函数最常规的调用场景，也就是向子节点路由插入的时候发现它满了，由于可能是最终的叶子节点，也就是插入数据的节点，所以必须要做处理：</p>
<div class="language-java highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><span class="w">            </span><span class="n">SearchResult</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="na">searchKey</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="na">getKey</span><span class="p">());</span>
</span><span id="__span-4-2"><span class="w">            </span><span class="c1">// 如果存在，则直接返回失败</span>
</span><span id="__span-4-3"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">isExist</span><span class="p">())</span>
</span><span id="__span-4-4"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
</span><span id="__span-4-5"><span class="w">            </span><span class="n">BTreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">V</span><span class="o">&gt;</span><span class="w"> </span><span class="n">childNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="na">childAt</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">getIndex</span><span class="p">());</span>
</span><span id="__span-4-6"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">childNode</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="c1">// 如果子节点是满节点</span>
</span><span id="__span-4-7"><span class="w">            </span><span class="p">{</span>
</span><span id="__span-4-8"><span class="w">                </span><span class="c1">// 则先分裂</span>
</span><span id="__span-4-9"><span class="w">                </span><span class="n">splitNode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">childNode</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="na">getIndex</span><span class="p">());</span>
</span><span id="__span-4-10"><span class="w">                </span><span class="cm">/* 如果给定entry的键大于分裂之后新生成项的键，则需要插入该新项的右边，</span>
</span><span id="__span-4-11"><span class="cm">                 * 否则左边。</span>
</span><span id="__span-4-12"><span class="cm">                 */</span>
</span><span id="__span-4-13"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">compare</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="na">getKey</span><span class="p">(),</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="na">entryAt</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">getIndex</span><span class="p">()).</span><span class="na">getKey</span><span class="p">())</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-4-14"><span class="w">                    </span><span class="n">childNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="na">childAt</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">getIndex</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-4-15"><span class="w">            </span><span class="p">}</span>
</span><span id="__span-4-16"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">insertNotFull</span><span class="p">(</span><span class="n">childNode</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">);</span>
</span><span id="__span-4-17"><span class="w">        </span><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>上述函数是<code>insertNotNull</code>中的一部分。可以看到这时候，是当前节点作为父节点，而叶子节点作为子节点传入，索引就是从父节点路由到子节点的索引值。</p>
<p>然后就是具体逻辑：</p>
<div class="language-java highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">splitNode</span><span class="p">(</span><span class="n">BTreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">V</span><span class="o">&gt;</span><span class="w"> </span><span class="n">parentNode</span><span class="p">,</span><span class="w"> </span><span class="n">BTreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">V</span><span class="o">&gt;</span><span class="w"> </span><span class="n">childNode</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-2"><span class="w">        </span><span class="k">assert</span><span class="w"> </span><span class="n">childNode</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">maxKeySize</span><span class="p">;</span>
</span><span id="__span-5-3">
</span><span id="__span-5-4"><span class="w">        </span><span class="n">BTreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">V</span><span class="o">&gt;</span><span class="w"> </span><span class="n">siblingNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BTreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">V</span><span class="o">&gt;</span><span class="p">(</span><span class="n">kComparator</span><span class="p">);</span>
</span><span id="__span-5-5"><span class="w">        </span><span class="n">siblingNode</span><span class="p">.</span><span class="na">setLeaf</span><span class="p">(</span><span class="n">childNode</span><span class="p">.</span><span class="na">isLeaf</span><span class="p">());</span>
</span><span id="__span-5-6"><span class="w">        </span><span class="c1">// 将满子节点中索引为[t, 2t - 2]的(t - 1)个项插入新的节点中</span>
</span><span id="__span-5-7"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">minKeySize</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
</span><span id="__span-5-8"><span class="w">            </span><span class="n">siblingNode</span><span class="p">.</span><span class="na">addEntry</span><span class="p">(</span><span class="n">childNode</span><span class="p">.</span><span class="na">entryAt</span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">));</span>
</span><span id="__span-5-9"><span class="w">        </span><span class="c1">// 提取满子节点中的中间项，其索引为(t - 1)</span>
</span><span id="__span-5-10"><span class="w">        </span><span class="n">Entry</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">V</span><span class="o">&gt;</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">childNode</span><span class="p">.</span><span class="na">entryAt</span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-5-11"><span class="w">        </span><span class="c1">// 删除满子节点中索引为[t - 1, 2t - 2]的t个项</span>
</span><span id="__span-5-12"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">maxKeySize</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="o">--</span><span class="n">i</span><span class="p">)</span>
</span><span id="__span-5-13"><span class="w">            </span><span class="n">childNode</span><span class="p">.</span><span class="na">removeEntry</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span><span id="__span-5-14"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">childNode</span><span class="p">.</span><span class="na">isLeaf</span><span class="p">())</span><span class="w"> </span><span class="c1">// 如果满子节点不是叶节点，则还需要处理其子节点</span>
</span><span id="__span-5-15"><span class="w">        </span><span class="p">{</span>
</span><span id="__span-5-16"><span class="w">            </span><span class="c1">// 将满子节点中索引为[t, 2t - 1]的t个子节点插入新的节点中</span>
</span><span id="__span-5-17"><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">minKeySize</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
</span><span id="__span-5-18"><span class="w">                </span><span class="n">siblingNode</span><span class="p">.</span><span class="na">addChild</span><span class="p">(</span><span class="n">childNode</span><span class="p">.</span><span class="na">childAt</span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">));</span>
</span><span id="__span-5-19"><span class="w">            </span><span class="c1">// 删除满子节点中索引为[t, 2t - 1]的t个子节点</span>
</span><span id="__span-5-20"><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">maxKeySize</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">t</span><span class="p">;</span><span class="w"> </span><span class="o">--</span><span class="n">i</span><span class="p">)</span>
</span><span id="__span-5-21"><span class="w">                </span><span class="n">childNode</span><span class="p">.</span><span class="na">removeChild</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span><span id="__span-5-22"><span class="w">        </span><span class="p">}</span>
</span><span id="__span-5-23"><span class="w">        </span><span class="c1">// 将entry插入父节点</span>
</span><span id="__span-5-24"><span class="w">        </span><span class="n">parentNode</span><span class="p">.</span><span class="na">insertEntry</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="p">);</span>
</span><span id="__span-5-25"><span class="w">        </span><span class="c1">// 将新节点插入父节点</span>
</span><span id="__span-5-26"><span class="w">        </span><span class="n">parentNode</span><span class="p">.</span><span class="na">insertChild</span><span class="p">(</span><span class="n">siblingNode</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-5-27"><span class="w">    </span><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>可以看到，其在满的子节点，也就是<code>child</code>的旁边创建一个兄弟节点<code>siblingNode</code>。</p>
<p><code>child</code>节点一共范围是<span class="arithmatex">\([0,2t-2]\)</span>，则分为三部分：</p>
<ul>
<li>[0, t-2] ,保留到child节点的数据</li>
<li>t-1，中位数的数据</li>
<li>[t,2t-2]，分到<code>silbingNode</code>的数据，之后<code>childNode</code>就可以将这部分删除</li>
</ul>
<p>然后的话，<code>child</code>节点一共只有<code>t-1</code>个数据了，并将中位数向上传递到<code>parent</code>，然后将<code>siblingNode</code>作为<code>child</code>的兄弟节点插入<code>parent</code>，</p>
<p>并且上去的中位数节点，就可以完美的在父节点中起到路由到<code>child/sibling</code>节点的功能了。</p>
<p>同时需要注意，这个路由上去的节点可能会改变本来下一个要插入的子树，因为新增加了一个兄弟节点，所以需要额外处理一下。</p>
<p>至于删除逻辑，是BTree真正复杂的地方，因为它设计到了维持平衡的左旋右旋等逻辑。暂时跳过。</p>
<p><strong>示例</strong></p>
<p><img alt="image.png" src="../assets/btree01.png" /></p>
<p>假设一个节点最多只能存储2个数据。则此时，<code>0002</code>就是<code>node</code>，而<code>0003,0004</code>就是<code>childNode</code>，并且<code>childNode</code>是满的。</p>
<p>按逻辑，如果要插入<code>0005</code>，则<code>childNode</code>就需要分裂了。则分为<code>child/sibling node</code>，并将中位数向上。同样，如果<code>root</code>满了，则同样需要分裂逻辑。</p>
<p><img alt="image.png" src="../assets/btree02.png" /></p>
<p>连续分裂的场景如下：</p>
<p><img alt="image.png" src="../assets/btree03.png" /></p>
<p>分裂之后：</p>
<p><img alt="image.png" src="../assets/btree04.png" /></p>
<h2 id="_8">设计思路<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h2>
<h3 id="_9">从开销看设计<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<h4 id="bb-tree">B&amp;B+ Tree<a class="headerlink" href="#bb-tree" title="Permanent link">&para;</a></h4>
<p>以HDD为例子。</p>
<p>首先是传统的二分设计：</p>
<p>假设当前的数据库存储了有<code>100万</code>数据的有序列表，每条数据<code>150</code>字节，并假设数据全在磁盘上。</p>
<p>我们都知道，数据在磁盘上并不是按照<code>扇区</code>的形式存储，而是按照<code>Block</code>，通常一个<code>block = 4KB、16KB</code>。而内存页通常是相等，或者与其有倍数关系(大小关系不一定)。则现在一个<code>block</code>存储了<code>100 record</code>，并且假设内存页大小是<code>4KB</code>。</p>
<p>假设磁盘的随机IO，寻找到一个<code>Block</code>的时间是<code>寻道时间 + 旋转时间 = 10毫秒</code>。</p>
<p>现在，我们可以对该有序列表进行二分查找，则操作次数是<code>log2 1000000</code> = 20次。因为假设所有数据都在磁盘中，所以理论上这20次都需要进行磁盘IO。</p>
<p>但是显然。因为读取的粒度都是页，所以我们当二分的范围缩小到100左右的时候，我们完全可以将数据局限在内存中读取到的<code>Block/page</code>，而不用再去进行IO。所以总共的磁盘IO时间是<code>14次左右</code>，我们将最后在100范围上进行的大约<code>6-7</code>次操作只用内存。</p>
<p>原始总开销: 20次二分，其中14次有磁盘IO，6次纯内存。</p>
<p>优化思路是什么呢？</p>
<p>我们可以将磁盘上存储数据的<code>block</code>的第一个<code>block</code>的第一笔<code>record</code>建立索引。而本身因为有序结构，一个<code>block</code>内的数据都是有序的。</p>
<p>所以我们可以通过<code>block</code>的粒度进行二分。</p>
<p>具体来说，有<code>100 万</code>的数据，而每个<code>block</code>有100笔记录，一共就需要10000个。所以我们维护这抽取出来的<code>10000</code>个<code>索引record</code>，在其上进行二分，这样的总二分次数就是<code>14</code>次，而不是之前的<code>20</code>次。</p>
<p>而总二分数是<code>14</code>次，内存页和<code>Block</code>都是<code>4KB</code>，则只需要<code>8</code>次IO，最后6次操作只需要内存。</p>
<p>到此的总开销：14次二分，其中8次有磁盘IO，6次纯内存。</p>
<p>而10000大小的辅助索引(稀疏索引)，我们可以在其上再次创建索引，再次减少二分次数。具体来说，这10000笔有索引功能的数据，可以存储到100个Block中，当然每个Block中的数据是有序的。而对这100个Block的每个的第一条数据，抽出来就可以做一个100大小的索引，并将他们缓存到内存中。</p>
<p>则此时要查找一条记录，就是对二级索引(size=100)做6次二分，但是纯内存不需要磁盘IO(初次需要IO)。然后需要对找到的大小为100的索引进行一次磁盘IO读取到内存中，进行6次二分，得到数据块的Block位置。最后到内存，进行6次纯内存操作即可。</p>
<p>到此的开销：18次二分 + 3 次磁盘IO，可以视作一次内存操作替换了一个磁盘操作，当然性能更加提升。</p>
<p>我们可以看到，B系列的树就是为减少磁盘IO而生的，B树就是完全实现了上面的设计，一级索引就是树的一层。</p>
<p>那B Tree 和 B+ Tree的区别是什么呢？</p>
<p><img alt="image.png" src="../assets/b%2BTree.png" /></p>
<p>可以看到，b+树的形式如上图所示。根上的<code>0002</code>，实际上并没有存储真正的数据，只有<code>K</code>而没有值，也就是对应的<code>V</code>，完整的数据会在叶子节点存储一份。</p>
<p>难道这不是冗余存储了吗？</p>
<p>是，但是其带来的优势是很大的。</p>
<p>之前的B树，每个<code>block</code>只能存储<code>100条大小为150字节的record</code>，但是现在如果只存<code>K</code>，则可以存<code>4000条</code>。</p>
<p>那么再次计算：一共100万条数据，底层存储在10000Block，这个是不变的。但是此时抽取出来的10000个索引，不再是<code>record</code>，而是单纯的<code>K</code>。假设其实<code>Int</code>，则需要的存储空间是<code>4B * 10000 = 40KB</code>，需要3个Block存储。则此时这三个Block可以直接缓存在内存。</p>
<p>也就是说，只需要一级索引就足够了，并且这一级索引的存储量远不止于此。</p>
<p>一般3层的B+树就可以存储千万级别的数据，4层的B+树可以存储千亿级别的数据。也就是说，最大的磁盘IO次数也就3，4次就够了。</p>
<h3 id="_10">从请求处理看设计<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h3>
<h4 id="lsm">LSM<a class="headerlink" href="#lsm" title="Permanent link">&para;</a></h4>
<blockquote>
<p>The Log-Structured Merge-Tree</p>
</blockquote>
<p>对于一个单机KV存储引擎，我们可以将它暴露给用户的API归纳为三类</p>
<ul>
<li>set</li>
<li>get</li>
<li>delete</li>
</ul>
<p><strong>存储介质</strong></p>
<p>首先声明，LSM针对的是海量数据的写入问题(比如日志数据)。所以，必然要选择磁盘作为存储介质。</p>
<p>在操作系统的部分，我们曾经分析过日志结构文件系统的设计，其实LSM就是其中的一种实现方式。</p>
<p><strong>写请求</strong></p>
<p>针对写请求，由于要将写优化到极致，而磁盘的顺序写和随机写的性能不是一个量级，所以必然要选择顺序写，并且是批量写。</p>
<p>最简单的方式，就是通过<code>append-only</code>方式来写。</p>
<p>我们可以通过一个日志文件，记录所有用户发起的请求(比如<code>add k-v</code>,<code>del k-v</code>)等。这个日志文件是<code>append-only</code>的。</p>
<p><strong>读请求</strong></p>
<p>写请求的方式已经通过WAL方式进行处理，那么读请求呢？可以在内存中维护一份全局数据的索引信息，查询的时候通过该索引进行查询即可。</p>
<blockquote>
<p>其实这里也是索引和数据共存</p>
</blockquote>
<p><strong>空间压缩</strong></p>
<p>通过多个数据操作，可能还有过期的数据保存在磁盘中，可以通过压缩<code>compact</code>的方式对数据存储进行压缩。</p>
<p><strong>压缩优化</strong></p>
<p>由于数据文件是临界资源，所以读写并发必然需要控制。为了减少阻塞问题，可以对文件进行分段，每次只在不相关的段上进行压缩即可。</p>
<p>压缩耗时问题优化：可以在存储的时候将数据有序存储，则进行压缩的时候可以进行多路归并排序(<code>合并k个有序链表</code>)。</p>
<p><strong>数据有序</strong></p>
<p>既然需要数据有序存储，右要求只追加，那么如何实现呢？具体方式就是按批写入的时候，将数据在内存中进行有序排序再写入。</p>
<p><strong>最终方案</strong></p>
<p><code>write</code>流程如下:</p>
<ol>
<li>预写WAL日志</li>
<li>写MemTable
   MemTable在达到阈值之后，转换为immutable,并重新开一个MemTable。Immutable内部数据有序(<code>因为本身就是有序数据结构，比如B+Tree或者跳表</code>)，并被一个写守护线程定时刷入磁盘，变为SSTable。</li>
</ol>
<p><code>Read</code>流程如下:</p>
<p>由于写入设计，所以数据的新旧关系: memtable &gt; immutable &gt; SSTable</p>
<p>所以就需要按照这个顺序进行读取，一但找到，则停止。并且可以通过<code>bloomFilter</code>的方式对数据进行过滤，加速寻找。</p>
<h2 id="_11">具体实现<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h2>
<h3 id="innodb">InnoDB<a class="headerlink" href="#innodb" title="Permanent link">&para;</a></h3>
<h4 id="_12">行格式<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h4>
<p>关系型数据库都是行存结构。所以如何设计行的结构来保持高效的存储与查找是很重要的。</p>
<p><strong>Compact格式</strong></p>
<p>每行数据的存储，具体分为元数据信息 + 真实数据。</p>
<p><code>元数据信息</code>：</p>
<ul>
<li>变长字段的长度列表，这里和列的顺序是倒序存储</li>
<li>NULL值列表，是一个<code>BitMap</code>。注意<code>Not Null</code>限定的列不会被计算</li>
<li>记录头信息,固定的5个字节，存储本行的各种信息。</li>
</ul>
<p><code>真实数据信息</code>，就是这一行数据每列的值，也就是表中看到的一行数据，但是，<code>InnoDB</code>会同时将添加3个隐藏列:</p>
<ul>
<li><code>row_id</code>，行ID，没有指定主键的情况下它会成为主键。</li>
<li><code>trx_id</code>，事务ID</li>
<li><code>roll_pointer</code>，回滚指针</li>
</ul>
<p>接下来，用一个具体例子来看</p>
<table>
<thead>
<tr>
<th>varchar(16)</th>
<th>char</th>
<th>varchar(16)</th>
</tr>
</thead>
<tbody>
<tr>
<td>aaa</td>
<td>bb</td>
<td>c</td>
</tr>
<tr>
<td>dd</td>
<td>Null</td>
<td>Null</td>
</tr>
</tbody>
</table>
<p>则这个表的第一行数据的Compact格式如下：</p>
<p>元数据信息</p>
<ul>
<li>变长字段长度列表：[01,03],</li>
<li>Null值列表：一个bitmap，[110] -&gt; 6,实际存储的时候就是用整数6存储</li>
<li>记录头信息</li>
</ul>
<p>数据信息</p>
<p>从左到右依次是三个隐藏列，然后是c1，c2 ....</p>
<blockquote>
<p>需要注意，由于可变列的存在，如果一行数据的某个列数据太大，超过了<code>Innodb</code>的一个页，也就是<code>16KB</code>，则会在该列的位置记录一部分数据，以及指向其他存储该列数据的页的指针。Text类型，varchar类型都可能成为溢出列。</p>
</blockquote>
<p><strong>Dynamic行格式</strong></p>
<p>其是默认的行格式，其和Compact格式的区别就是其会将溢出列全部存储到另一页上，本行位置只保留一个指针即可。</p>
<h4 id="_13">数据页<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h4>
<p><strong>userRcords</strong></p>
<p>首先，每次用户插入一条数据，都是向页申请空闲空间，然后存储到<code>user records</code>部分。</p>
<p>多行数据按照<code>Dynamic</code>格式按主键顺序紧密存储在同一个页中，一个页的头部和尾部分别是两个虚拟的数据，代表本页的最小和最大<code>record</code>.</p>
<p>之前我们说的记录头信息之中，有一个字段就是<code>next_record</code>，其将多行数据的真实数据部分(非元数据信息)串联起来，一行的next_record存储的就是下一行真实数据开头地址的指针。</p>
<p><strong>页目录</strong></p>
<p>就是在这一个<code>16KB</code>大小的页中，再划分为组，由于是按照顺序组织的，所以将每组的最值提取出来，就可以构建索引，从而进行多路搜索。</p>
<h4 id="_14">索引<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h4>
<p><code>InnoDB</code>中给索引进行了分类，具体有以下几种</p>
<p><strong>聚簇索引</strong></p>
<p>正常情况下,<code>InnnoDB</code>中所有的数据都是通过主键值有序存储在B+树的形式组织起来，这种最常规的方式其实也是一种索引，被称为<code>聚簇索引</code>。</p>
<p>索引即数据，数据即索引，说的就是它。</p>
<p><strong>二级索引</strong></p>
<p>由于主存储树是通过主键值的有序存储建立起来的索引，那么如果向通过别的列作为搜索条件的时候，就无法进行二分了。</p>
<p>如果我们的条件列是C,那么将<code>(C,ID)</code>作为数据有序组织起来构建一颗b+树即可。最后查找的是主键ID，再到主存储树进行一次回表查询即可。</p>
<p>这样既不用全量复制一份，也可以享受到索引的加速。</p>
<p><strong>联合索引</strong></p>
<p>就是现在不通过主键，而是通过<code>其他多个列</code>作为条件进行查询。则此时就是将<code>(k1-k2-k3,ID)</code>作为数据组织起来构建b+树，最后回表查询。</p>
<h4 id="_15">表空间<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h4>
<p><code>InnoDB</code>存储引擎，是通过<code>页</code>的方式来信息数据组织的，其中<code>B+</code>树的一个节点就用一个页来存储。</p>
<p><strong>页的种类</strong></p>
<ul>
<li>最新空页</li>
<li>数据页</li>
<li>溢出页</li>
<li>表空间信息、事务信息</li>
<li><code>Change Buffer</code>相关</li>
</ul>
<p><strong>页的通用部分</strong></p>
<p>就是<code>File Header和 File tailer</code>。其他的都是不同的。</p>
<p><strong>区</strong></p>
<p>是更粗粒度的空间结构。因为构建的聚簇索引或者二级索引，一个页存储不下的时候，就必须要跨页。而如果索引放到一个统管理的大片区域中，就会减少大量的随机IO。所以就有了区的概念。</p>
<p>在<code>InnoDB</code>中，每64个页就是一个区。</p>
<h3 id="lsm_1">LSM<a class="headerlink" href="#lsm_1" title="Permanent link">&para;</a></h3>
<h4 id="_16">双组件结构<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h4>
<p>双组件结构的LSM存储引擎，包含一个内存中的树结构和一个磁盘中的树结构(B+树/跳表都可以)。数据首先在内存，随后被定时转到磁盘中去。</p>
<p>由于磁盘中，只维护了一个磁盘文件(树结构)，则其需要不断和内存数据进行合并，效率较低。</p>
<h4 id="_17">多组件结构<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h4>
<p>内存组件仍然只有一个，但是磁盘组件有多个，并进行异步滚动合并。</p>
<h4 id="_18">实际结构<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h4>
<p>至少一个内存组件 + 多个磁盘组件构成。</p>
<p>内存组件异步写入磁盘，成为一个磁盘组件，称为<code>Minor Compact</code>。磁盘组件和磁盘组件也会按需合并，维护磁盘组件的数量稳定，称为<code>Major Compact</code>。</p>
<p><strong>MemTable</strong></p>
<p>一个内存中的有序数据的集合，通过有序数据结构，比如<code>B+</code>Tree或者跳表实现(<code>LevelDB</code>是跳表，因为简单并且性能OK)。</p>
<p>同一时刻只有一个MemTable处理写操作，当其内存占用大小达到/定期，通过一个写线程将其异步刷盘。关闭并开启新的<code>MemTable</code>的过程是原子的(通过互斥锁保证)。</p>
<div class="language-java highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">flushMemTable</span><span class="p">()</span>
</span><span id="__span-6-2"><span class="w">    </span><span class="p">{</span>
</span><span id="__span-6-3"><span class="w">        </span><span class="n">mutex</span><span class="p">.</span><span class="na">lock</span><span class="p">();</span>
</span><span id="__span-6-4"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-5"><span class="w">            </span><span class="c1">// force compaction</span>
</span><span id="__span-6-6"><span class="w">            </span><span class="n">makeRoomForWrite</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
</span><span id="__span-6-7">
</span><span id="__span-6-8"><span class="w">            </span><span class="c1">// todo bg_error code</span>
</span><span id="__span-6-9"><span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">immutableMemTable</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-10"><span class="w">                </span><span class="n">backgroundCondition</span><span class="p">.</span><span class="na">awaitUninterruptibly</span><span class="p">();</span>
</span><span id="__span-6-11"><span class="w">            </span><span class="p">}</span>
</span><span id="__span-6-12">
</span><span id="__span-6-13"><span class="w">        </span><span class="p">}</span>
</span><span id="__span-6-14"><span class="w">        </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-15"><span class="w">            </span><span class="n">mutex</span><span class="p">.</span><span class="na">unlock</span><span class="p">();</span>
</span><span id="__span-6-16"><span class="w">        </span><span class="p">}</span>
</span><span id="__span-6-17"><span class="w">    </span><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p><strong>SSTable</strong></p>
<p>来自于内存中的异步刷盘，或者通过SSTable之间的合并得到，每个SSTable内部数据始终有序。</p>
<h2 id="_19">事务专项<a class="headerlink" href="#_19" title="Permanent link">&para;</a></h2>
<blockquote>
<p>参考《数据库系统内幕》</p>
</blockquote>
<h3 id="_20">核心概念<a class="headerlink" href="#_20" title="Permanent link">&para;</a></h3>
<p>事务是指一个数据库中不可分割的逻辑单元，允许将多个操作(读取or写入)表示为一个步骤。</p>
<p>ACID</p>
<ul>
<li>原子性，事务是不可分割的。也就是事务不可以被部分应用，每个事务要么成功提交(使内存写操作产生的所有更改变得可见)，要么中止(回滚所有尚不可见的事务副作用)。提交是事务的最后一个操作，中止后可以重试</li>
<li>一致性，事务只能将数据库从一个有效状态带到另一个有效状态，并保持所有的数据库不变量</li>
<li>隔离性，多个并发执行的事务应该能够互不干扰地运行，每个事务都像没有其他事务在同时执行一样。出于性能原因，许多数据库使用的隔离级别要弱于这里给出的隔离性定义</li>
<li>持久性，一旦事务被提交，所有数据库状态的修改都必须被持久化到磁盘上，即使之后发生断电、系统故障或崩溃也不受影响</li>
</ul>
<p>其他组件</p>
<ul>
<li>锁管理器，锁管理器可保护对资源的访问，并防止那些可能破坏数据完整性的并发访问。每当请求加锁时，锁管理器会检查这个锁是否已被其他事务以共享或排他模式持有，如果请求的访问级别没有冲突则允许本次访问。由于排他锁在任意时刻最多只能被一个事务持有，所以其他请求加锁的事务必须等待锁被释放，或者中止事务并稍后重试。一旦锁被释放或事务终止，锁管理器就会通知其中一个挂起的事务，让它获得锁并继续执行</li>
<li>页缓存(这里绕过内核页缓存，是用户态内存中的的等价实现)，充当了持久性存储（磁盘）和存储引擎其余部分之间的中介</li>
<li>日志管理器，记录了已应用在缓存页上的操作（日志条目），这些操作尚未与持久性存储同步，而日志可以确保这些操作不会在崩溃时丢失</li>
</ul>
<h3 id="_21">页缓存<a class="headerlink" href="#_21" title="Permanent link">&para;</a></h3>
<p>页缓存通常指两种，一种是OS概念中内核页缓存，一种是数据库中的页缓存(buffer pool)。</p>
<p>区别就是DB通常会使用O_DIRECT标志打开文件，它允许I/O系统调用绕过内核页缓存直接访问磁盘，直接是用户态内存和磁盘交互。</p>
<p>为什么要使用这样的方式呢，明明有现成的page cache？就是因为虽然可以通过fadvise这个系统调用从某种程度上控制内核如何将页换出页缓存，但这仅仅是让内核考虑我们的意见，并不保证它一定会发生。所以为了进一步进行细粒度控制，就会放弃掉kernel page cache，将其在用户态内存等价实现。它和内核页缓存一样，都是对磁盘访问的抽象，同时将逻辑写和物理写操作分离。</p>
<h4 id="_22">页缓存的语义<a class="headerlink" href="#_22" title="Permanent link">&para;</a></h4>
<p>它是内核页缓存的用户态等价实现</p>
<p>当存储引擎访问（或请求）页时，我们首先检查其内容是否已被缓存。如果该页在缓存中，则直接返回缓存的页。如果该页未被缓存，则页缓存会将其逻辑地址或页号转换为物理地址，并将它的内容加载到内存，然后返回已缓存的版本给存储引擎。一旦返回，这个存有缓存页内容的缓冲区就称为被引用的(referenced)，存储引擎必须在用完之后将其归还给页缓存或解除引用。若想让页缓存不要换出某些页，则可以将它们固定(pin)。如果某个页被修改了,则变为dirty,必须刷写到磁盘才能保证持久性。</p>
<h4 id="_23">缓存回收<a class="headerlink" href="#_23" title="Permanent link">&para;</a></h4>
<p>通常会单独开一个刷写后台进程/线程，循环检查可能被换出的脏页，更新其磁盘上的版本。</p>
<p>为了确保所有更改都被持久化，检查点进程会协调刷写进程。检查点进程控制预写日志(WAL)和页缓存，并确保两者协同工作。只有当缓存页完成刷写之后，相关操作的日志记录才能从WAL中丢弃。在上述过程完成后才能将脏页换出缓存。</p>
<h4 id="_24">锁定页<a class="headerlink" href="#_24" title="Permanent link">&para;</a></h4>
<p>以B树为例子，随着节点层次的降低，每层的节点数量呈指数级增加，并且较高层次的节点仅占整棵树的一小部分，因此这部分节点可以永久驻留在内存中，而其他部分则可以按需换入。</p>
<h4 id="_25">页置换<a class="headerlink" href="#_25" title="Permanent link">&para;</a></h4>
<p>FIFO,LRU,LFU</p>
<h3 id="_26">恢复<a class="headerlink" href="#_26" title="Permanent link">&para;</a></h3>
<h4 id="wal">WAL<a class="headerlink" href="#wal" title="Permanent link">&para;</a></h4>
<p>核心就是WAL，也就是Write-Ahead Log，预写日志。通常是append only。</p>
<p>功能：</p>
<ul>
<li>在允许页缓存将页上的修改缓存起来的同时，保证数据库系统仍然具有持久性语义。在那些受操作影响的缓存页被同步到磁盘上之前，将所有操作持久化到磁盘上。每个修改数据库状态的操作必须先写日志到磁盘上，然后才能修改相关页的内容(WAL刷写，早于内存页操作)</li>
<li>当发生崩溃时，使系统可以从操作日志中重建内存中丢失的更改</li>
</ul>
<p>组成：WAL由日志记录组成，每条记录都有一个唯一的、单调递增的日志序列号(LSN)。通常，LSN由一个内部的计数器或时间戳表示。各日志记录必须以LSN的顺序刷写到磁盘上。除了单独的操作记录外，WAL还会保存事务完成的记录。只有当事务提交记录完成刷盘之后，才能将该事务视为已提交。</p>
<h4 id="_27">操作日志和数据日志<a class="headerlink" href="#_27" title="Permanent link">&para;</a></h4>
<p>状态变换：一个state，通常有before-image和after-image两部分组成。对before-image进行redo，得到after-image。对after-image进行undo，得到before-image。</p>
<p>日志类型：逻辑日志(保存当前状态上执行的操作)，以及物理日志(保存对完整页状态或字节级的更改)。</p>
<p>通常数据库，都是使用逻辑日志进行undo(语义级别，更好逆向，提升并发)。使用物理日志进行redo(直接Byte级别修改对应页位置值，缩短恢复时间)。撤销操作会回滚那些已提交事务强制刷盘的页上的更新，而重做操作会将已提交事务执行的更改应用到磁盘上。</p>
<h4 id="steal-or-force">steal or force<a class="headerlink" href="#steal-or-force" title="Permanent link">&para;</a></h4>
<p>steal/no steal，以及force/no force是页缓存部分的策略，但是会影响进行恢复的方法。</p>
<p>在事务提交之前允许刷写事务修改过的页，这被称为steal策略。而no-steal策略不允许将未提交的事务内容刷写到磁盘。之所以称为steal策略，是因为它将脏页偷窃(steal)出来，将其中的内容刷写到磁盘上，并从磁盘加载另一个页到该位置。</p>
<p>force策略要求在事务提交前将事务修改的所有页刷写到磁盘上。而在no-force策略中，即使事务修改的某些页尚未刷写到磁盘上，该事务也可以提交。这里force的含义是强制(force)脏页在事务提交前必须将其刷写到磁盘上。</p>
<ul>
<li>使用no-steal策略，则只需要redo就可以实现恢复。因为旧副本包含在磁盘的页上，而修改被存储在WAL日志中(直接将WAL中状态修改通过Byte级别操作应用到磁盘数据页中)。</li>
<li>使用force策略，则崩溃恢复无须任何其他工作即可重建已提交事务的结果，因为这些事务修改的页都已被刷写到磁盘。则磁盘只要不被破坏，就可以保证直接恢复。</li>
</ul>
<p>更一般地说，直到事务提交前，我们需要保存有足够的信息来撤销它的结果。如果事务中涉及的页都已经刷写到磁盘，那么我们需要在日志中保留撤销信息，以在事务提交之前确保它能被回滚；否则，我们必须保留重做日志。在这两种情况下，只有当撤销或重做记录被写入日志文件后，事务才能提交。</p>
<h4 id="aries">ARIES<a class="headerlink" href="#aries" title="Permanent link">&para;</a></h4>
<p>是一种针对页缓存使用steal &amp; no-force恢复算法。</p>
<p>恢复过程分为三个阶段</p>
<ul>
<li>分析阶段，识别出页缓存中的脏页，以及崩溃时正在进行的事务</li>
<li>redo阶段，物理重做，也就是在页级别，重放历史记录到崩溃点，将数据库恢复到原来状态。核心是处理未完成的事务，以及完成但是没有将脏页刷出的事务。</li>
<li>undo阶段，逻辑撤销，也就是在记录级别，会回滚所有没有完成的事务，将数据库还原到最后的状态。同时将undo的日志也记录下来。</li>
</ul>
<h3 id="_28">并发控制<a class="headerlink" href="#_28" title="Permanent link">&para;</a></h3>
<p>数据库通常使用事务管理器和锁管理器来协同处理并发控制。</p>
<p>通常并发控制有如下几种类型</p>
<ul>
<li>乐观并发控制(OCC)：首先允许多个事务并发在同一个上下文并发执行读取和写入操作，最后确定执行结果能否被串行化。也就是事务不会彼此阻塞，而是保留其操作历史，并在提交前检查是否存在冲突的可能性。如果存在，则会中止其中某个冲突的事务。</li>
<li>多版本并发控制(MVCC)：允许一条记录存在多个时间戳版本。也就是事务读取的是数据库某个时刻的快照视图。具体实现可以通过验证技术(即多结果对比)，或者无锁技术(时间戳排序)，或者有锁技术(二阶段锁)。</li>
<li>悲观并发控制(PCC)：也就是保守并发控制，可以使用锁也可以不用。基于锁会将某个记录锁定，而不加锁的方式是通过在事务调度中维护读取 &amp; 写入的操作列表以限制事务运行。悲观的调度可能导致死锁。</li>
</ul>
<blockquote>
<p>调度(schedule)是指数据库视角上执行一组事务所需的操作列表（即仅包含与数据库状态交互的操作，例如读、写、提交和中止)。并发控制就是在串行基础上修改，使得某些事务的顺序改变或者同时执行，只要能够满足ACID，同时保证结果正确即可。</p>
</blockquote>
<h4 id="_29">可串行化<a class="headerlink" href="#_29" title="Permanent link">&para;</a></h4>
<p>即完全串行执行事务列表，正确性可以保证但是效率极大降低。</p>
<h4 id="_30">事务隔离<a class="headerlink" href="#_30" title="Permanent link">&para;</a></h4>
<p>事务型数据库系统有着不同的隔离级别。隔离级别指定了事务的各部分如何以及何时可以被其他事务看到，以及可能出现的异常。而实现隔离需要付出一定代价，也就是额外的协调以及同步机制。</p>
<p>SQL标准中的读写异常类型</p>
<p><strong>读异常</strong></p>
<ul>
<li>脏读， 指的是一个事务能读取到其他事务没有提交的更改，并且可能是一个从未提交过的值。</li>
<li>不可重复读，是指同一个事务两次查询同一行却得到不同的结果。</li>
<li>幻记录，是指事务执行两次范围查询，得到不同的结果集合的结果。</li>
</ul>
<p><strong>写异常</strong></p>
<ul>
<li>丢失更新， 是指多个事务进行更新的时候，由于不是原子性，所以未提交的结果可能被其他事务覆盖的情况。</li>
<li>脏写，指的是某个事务拿到一个从未提交过的值，对其修改并保存。</li>
<li>写偏斜，是指单个事务都遵循要求的约束，但是组合却违反了约束。(比如非负情况)</li>
</ul>
<h4 id="_31">隔离级别<a class="headerlink" href="#_31" title="Permanent link">&para;</a></h4>
<p>从上到下依次增强：</p>
<ul>
<li>读未提交，也就是会有脏读，不可重复读，幻读</li>
<li>读已提交，也就是会有不可重复读，幻读</li>
<li>可重复读(通常通过快照隔离机制实现)，也就是会有幻读。</li>
<li>可串行化</li>
</ul>
<h4 id="_32">乐观并发控制<a class="headerlink" href="#_32" title="Permanent link">&para;</a></h4>
<blockquote>
<p>乐观并发空值总是假设事务冲突很少发生</p>
</blockquote>
<p>分为以下阶段</p>
<ul>
<li>读阶段，事务在私有上下文中执行，完成之后就确定了事务的读集合，以及写集合。</li>
<li>验证阶段，也就是针对多个事务的读集合，写集合来验证结果是否冲突。</li>
<li>写阶段，将结果从私有上下文，提交到数据库状态。</li>
</ul>
<p>常见的验证方式是后向式验证，也就是检查和已提交事务的冲突。在极短的验证阶段，不允许任何事务提交，这是任何数据库都要遵守的条件。如果满足：</p>
<ul>
<li>t1在t2的读阶段开始之前提交，则t2可以提交。</li>
<li>t1没有写入任何t2看到的值，则t2可以提交。</li>
<li>t1和t2操作独立的数据集合，则两者均提交。</li>
</ul>
<h4 id="_33">多版本并发控制<a class="headerlink" href="#_33" title="Permanent link">&para;</a></h4>
<p>使用MVCC，则读写操作在存储层面上只需要最小限度的协调，因为读操作可以继续访问旧的值，直到新的值被提交。</p>
<p>MVCC区分已提交和未提交的版本，对应于已提交和未提交事务的值的版本。最后提交的值的版本也就是值的当前版本。一般在MVCC中，事务管理器的目标是确保任一时刻最多只有一个未提交的值版本。</p>
<p>通常通过MVCC来实现快照隔离机制，也就是可重复读 - 读写不相互阻塞，同时一个事务看到的是一致性快照。</p>
<h4 id="_34">悲观并发控制<a class="headerlink" href="#_34" title="Permanent link">&para;</a></h4>
<p>悲观并发控制方案比乐观方案更保守,通常通过加锁来实现。这种方案在事务运行时确定其间的冲突并阻塞或中止执行。</p>
<p>常见方法之一，就是记录每个record的max_read_timestamp和max_write_timestamp。如果读操作的时间戳小于max_write_timestamp，则事务中止。而如果写操作的时间戳小于max_read_timestamp,理论上不允许，但是实践中后者是允许的。每次读写完成，时间戳会被更新。</p>
<p>悲观并发控制，使用的是两阶段锁(2PL)。这种锁管理有两个阶段：首先是增长阶段，也就是将获取事务所需的所有锁，并且不释放任何锁。其次是收缩阶段，此阶段释放增长阶段获得的所有锁。</p>
<p>此处事务一旦释放了一个锁，就不能再获得任何锁。</p>
<p><strong>lock &amp; latch</strong></p>
<p>事务处理中，负责逻辑完整性的是lock，而负责物理完整性的是latch。后者是代码实现中的锁，比如可重入锁等。</p>
<p>锁用于隔离和调度重叠的事务、管理数据库内容（而非内部存储结构），并且锁是在键上获取的。锁可以保护某个特定的键（无论该键存不存在）或一个范围内的键。锁通常在树实现之外进行存储和管理，它表示一个较高层级的概念，由数据库的锁管理器管理。</p>
<blockquote>
<p>这里就可以知道，数据库中常说的锁其实并不是代码实现中的锁，后者通常以latch出现。所谓的无锁并发控制技术，也只是逻辑层面，代码实现层面也必然会有latch。</p>
</blockquote>
<p>latch是在页级别上获取的。在访问任何页之前，必须要先加latch，以确保并发安全。由于叶节点上的修改可能会传播到B树的更高层，所以可能要在多个层上获得闩锁。</p>
<p>通常，数据库并发操作有如下三类：</p>
<ul>
<li>并发读</li>
<li>并发更新</li>
<li>写时读</li>
</ul>
<p>针对第一种情况，出现了读写锁。其支持在并发读的时候没有排他性，也就是可以共享锁资源所有权。其他组合都需要获得排他性所有权。</p>
<p><strong>latch coupling</strong></p>
<p>latch耦合，指的是它允许持有闩锁的时间更短，并在当前操作(代码层面)明显不再需要它们时立即释放。</p>
<ul>
<li>读取时，一旦找到子节点并获得它的闩锁，就可以释放父节点的闩锁。</li>
<li>插入时，如果子节点还没满，则可以释放父闩锁。</li>
<li>删除时，如果子节点包含足够多的元素，或者该操作不会导致节点合并，则可以释放父节点上的闩锁。</li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      lx CC-BY-4.0
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.top", "navigation.indexes", "navigation.expand", "search.suggest", "search.highlight", "content.code.copy", "content.action.edit"], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.50899def.min.js"></script>
      
        <script src="../../javascripts/katex.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/katex.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/contrib/auto-render.min.js"></script>
      
    
  </body>
</html>